-- find the bike stations with neighbors who have low availability on a given timestamp 


docker exec mariadb_graph mariadb -uroot -proot -D graphdb -NBe "SELECT origid,destid FROM trip_graph WHERE latch='breadth_first' AND seq=1" | docker exec -i mcs1 mariadb -uroot -D bike_analytics --local-infile=1 -e "CREATE TABLE IF NOT EXISTS pairs_stage (src BIGINT UNSIGNED,dst BIGINT UNSIGNED,PRIMARY KEY(src,dst)) ENGINE=InnoDB; TRUNCATE pairs_stage; LOAD DATA INFILE '/tmp/pairs.tsv' INTO TABLE pairs_stage (src,dst); SET @t=TIMESTAMP('2025-08-04 10:20:00'), @threshold=3; WITH latest AS ( SELECT station_id, MAX(ts) AS ts FROM available_bikes_ts WHERE ts<=@t GROUP BY station_id ), snap AS ( SELECT m.station_id, m.value FROM available_bikes_ts m JOIN latest l ON l.station_id=m.station_id AND l.ts=m.ts ) SELECT ssrc.name AS src, GROUP_CONCAT(sdst.name ORDER BY sdst.name) AS low_neighbors FROM pairs_stage p JOIN stations ssrc ON ssrc.id=p.src JOIN stations sdst ON sdst.id=p.dst JOIN snap ON snap.station_id=p.dst WHERE snap.value<=@threshold GROUP BY ssrc.id, ssrc.name;"
